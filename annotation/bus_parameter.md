# TESPy Bus类`add_comps`方法详解手册

## 目录

1. [方法概述](#方法概述)  
2. [参数详解](#参数详解)  
3. [使用示例](#使用示例)  
4. [能量流方向与char参数](#能量流方向与char参数)  
5. [base参数对比](#base参数对比)  
6. [验证与调试](#验证与调试)  
7. [常见问题解答](#常见问题解答)

---

## 方法概述 <a name="方法概述"></a>

`Bus.add_comps()`是TESPy中用于将能量组件关联到总线的核心方法，主要功能包括：

- 定义组件与总线的能量流关系
- 设置变工况特性曲线
- 指定参考基准模式
- 实现系统级能量平衡

---

## 参数详解 <a name="参数详解"></a>

### 1. `comp` (必需)

- **类型**: TESPy组件对象
- **作用**: 指定要关联的组件实例
- **示例组件**:
  
  ```python
  Pump, HeatExchanger
  ```

### 2. `param` (可选)

- **类型**: 字符串
- **可选值**:
  
  | 值       | 含义                  | 适用组件               |
  |----------|-----------------------|-----------------------|
  | `'P'`    | 电/机械功率           | 发电机、泵、内燃机     |
  | `'Q'`    | 热量传递              | 换热器、锅炉          |
  | `'TI'`   | 燃料热输入            | 燃烧类组件            |
  | `'Qloss'`| 热损失                | 所有热力组件          |

### 3. `char` (可选)

- **类型**: `CharLine`对象 或 `-1`,`1`
- **作用**:
  - **特性曲线**: 定义变工况下的效率/功率特性
  - **`-1`**: 表示能量流 **流入总线**, 即具体设备 **释放热量**
  - **`1`**: 表示能量流 **流出总线**, 即具体设备 **吸收热量**
- **默认行为**: 使用组件默认特性曲线

### 4. `base` (可选)

- **类型**: `'bus'` 或 `'comp'`
- 在TESPy的add_comps方法中，base参数用于定义功率或效率的参考基准，直接影响非设计工况下的计算逻辑。

#### ***base='comp'（默认值）***

含义：以组件的额定参数为基准进行效率/功率计算。

**计算逻辑**：
总线功率 = 组件额定功率 × (当前效率 / 额定效率)

**适用场景**：
组件性能独立于总线需求（如固定转速泵、定功率发电机）
需要保持组件的固有特性（如设计点效率）

**示例（内燃机）**：
```
# 内燃机额定功率P_ref=1 MW，设计效率η=40%
# 当前效率下降至35%时：
总线功率 = 1e6 W × (0.35 / 0.40) = 875 kW
```

#### ***base='bus'***

**含义**：以总线的需求功率为基准反向计算组件效率。

**计算逻辑**：
组件效率 = 额定效率 × (总线需求功率 / 组件额定功率)

**适用场景**：
组件运行服从总线调度（如变速泵、负荷跟随型发电机）
需要优先满足系统级能量平衡

**示例（冷却水泵）**：
```
# 泵额定功率P_ref=50 kW，设计效率η=80%
# 总线需求功率降至40 kW时：
泵效率 = 0.8 × (40e3 / 50e3) = 64%
```

- **作用对比**:
  
  | 参数          | `base='comp'`                | `base='bus'`                |
  |--------------|------------------------------|-----------------------------|
  | 参考基准      | 组件额定参数                 | 总线需求功率                |
  | 计算方向      | 组件效率 → 总线功率          | 总线需求 → 组件效率         |
  | 适用场景      | 固定工况设备                 | 负荷跟随设备                |

### 5. `P_ref` (可选)

- **类型**: 浮点数（单位：瓦特）
- **作用**: 设定参考工况下的额定功率值

---

## 使用示例 <a name="使用示例"></a>

### 示例1：功率总线配置

```python
# 定义特性曲线
gen = CharLine(x=load, y=eff)  # 发电机特性
mot = CharLine(x=load, y=eff)  # 电动机特性

# 添加组件到总线
power_bus.add_comps(
    {'comp': chp, 'char': gen, 'param': 'P'},  # 内燃机输出机械功率
    {'comp': pu, 'char': mot, 'base': 'bus'}   # 水泵以总线需求为基准
)
```

### 示例2：热总线配置

```python
heat_bus.add_comps(
    {'comp': chp, 'param': 'Q', 'char': -1},  # 内燃机释放废热，被总线回收
    {'comp': fgc, 'char': -1}                 # 烟气释放余热，被总线回收
)
```

---

## 能量流方向与char参数 <a name="能量流方向与char参数"></a>

### 方向规则

- **`char=特性曲线`**：能量流出总线（正值）
- **`char=-1`**：能量流入总线（负值）

### 热总线配置解析

```python
# 内燃机和烟气冷却器均标记为char=-1
heat_bus.add_comps(
    {'comp': chp, 'char': -1},  # 废热流入总线
    {'comp': fgc, 'char': -1}   # 余热流入总线
)
```

- **设计逻辑**：两者均为系统热源，需统一标记为流入总线
- **能量平衡**：总线总热输入 = ∑(组件热流绝对值)

---

## base参数对比 <a name="base参数对比"></a>

### 计算逻辑对比

| 场景                  | `base='comp'`公式              | `base='bus'`公式              |
|-----------------------|--------------------------------|-------------------------------|
| 设计工况              | `P_bus = P_ref`               | `η_comp = η_ref`             |
| 非设计工况            | `P_bus = P_ref × (η/η_ref)`   | `η_comp = η_ref × (P_bus/P_ref)` |

### 典型应用场景

- **`base='comp'`**  
  - 燃气轮机驱动发电机
  - 固定转速泵

- **`base='bus'`**  
  - 微电网负荷调度
  - 余热回收系统热平衡

---

## 验证与调试 <a name="验证与调试"></a>

### 1. 结果查看

```python
nw.print_results()  # 查看总线汇总数据
```

### 2. 效率验证代码

```python
# 设计点求解
nw.solve(mode='design')
print(f"设计效率: {pu.eta_s.val}")

# 非设计点验证
power_bus.set_attr(P=-8e6)
nw.solve(mode='offdesign') 
print(f"非设计效率: {pu.eta_s.val}")
```

### 3. 能量守恒检查

```python
total_heat = abs(chp.Q1.val) + abs(fgc.Q.val)
print(f"理论热值: {total_heat} W")
print(f"总线热值: {heat_bus.P.val} W")
```

---

## 常见问题解答 <a name="常见问题解答"></a>

### Q1: 如何判断该用`'P'`还是`'Q'`参数？

- **机械/电力系统** → `'P'`
- 热力系统 → `'Q'`
- 燃料系统 → `'TI'`

### Q2: 为什么有时需要设置`P_ref=None`？

- 当需要总线自动计算参考功率时，需清除预设值：
  
  ```python
  heat_bus.set_attr(P=None)  # 启用自动计算
  ```

### Q3: 多个总线如何协同工作？

- **典型架构**：
  
  ```mermaid
  graph LR
    Fuel[燃料总线] --> Engine
    Engine -->|P| Power[电总线]
    Engine -->|Q| Heat[热总线]
    Heat --> Storage[储热罐]
  ```